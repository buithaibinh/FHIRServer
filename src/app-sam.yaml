AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  Stage:
    Type: String
    AllowedValues:
      - beta
      - gamma
      - prod
    Default: beta
    Description: Stage that can be added to resource names
  LambdaAlias:
    Type: String
    Default: live
    Description: The alias used for live production traffic to the Lambda function.    

Globals:
  Api:
    EndpointConfiguration: REGIONAL

Resources:
  OrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: "user_id"
          AttributeType: "S"
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "user_id"
          KeyType: "HASH"
        - AttributeName: "id"
          KeyType: "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  OrdersQueue:
    Type: AWS::SQS::Queue

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      AutoVerifiedAttributes: 
        - email
      UserPoolName: !Ref AWS::StackName
      Schema:
        - AttributeDataType: String
          Name: email
          Required: true
        - AttributeDataType: String
          Name: cc_confirmed

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${AWS::StackName}-UserPool'
      GenerateSecret: false
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows: 
        - ADMIN_NO_SRP_AUTH

  ApiSqsRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - Effect: "Allow"
            Principal: 
              Service: 
                - "apigateway.amazonaws.com"
            Action: 
              - "sts:AssumeRole"
      Policies:
        - PolicyName: sqs_access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !GetAtt OrdersQueue.Arn     
  FHIRServiceApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: 'Dev'
      DefinitionBody:
        swagger: "2.0"
        info:
          version: "2"
          title: "FHIR Patient"
        host: "e96hmlcijc.execute-api.us-west-2.amazonaws.com"
        basePath: "/dev"
        schemes:
        - "https"
        paths:
          /:
            get:
              operationId: "GET /"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              operationId: "POST /"
              produces:
              - "application/json"
              responses:
                201:
                  description: "201 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /$meta:
            get:
              operationId: "GET /$meta"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
          /Patient:
            get:
              operationId: "GET /Patient"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              operationId: "POST /Patient"
              produces:
              - "application/json"
              responses:
                201:
                  description: "201 response"
                400:
                  description: "400 response"
                404:
                  description: "404 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/$meta:
            get:
              operationId: "GET /Patient/$meta"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/$validate:
            get:
              operationId: "GET /Patient/$validate"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/_history:
            get:
              operationId: "GET /Patient/_history"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/_search:
            get:
              operationId: "GET /Patient/_search"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/_tags:
            get:
              operationId: "GET /Patient/_tags"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/_validate/{id}:
            post:
              operationId: "POST /Patient/_validate/{id}"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                201:
                  description: "201 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}:
            get:
              operationId: "GET /Patient/{id}"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
                410:
                  description: "410 response"
                422:
                  description: "422 response"
                404:
                  description: "404 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              operationId: "PUT /Patient/{id}"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
                201:
                  description: "201 response"
                422:
                  description: "422 response"
                400:
                  description: "400 response"
                412:
                  description: "412 response"
                404:
                  description: "404 response"
                405:
                  description: "405 response"
                409:
                  description: "409 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            delete:
              operationId: "DELETE /Patient/{id}"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                204:
                  description: "204 response"
                404:
                  description: "404 response"
                405:
                  description: "405 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/$everything:
            get:
              operationId: "GET /Patient/{id}/$everything"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/$validate:
            get:
              operationId: "GET /Patient/{id}/$validate"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_history:
            get:
              operationId: "GET /Patient/{id}/_history"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_history/{vid}:
            get:
              operationId: "GET /Patient/{id}/_history/{vid}"
              produces:
              - "application/json"
              parameters:
              - name: "vid"
                in: "path"
                required: true
                type: "string"
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_history/{vid}/_tags:
            get:
              operationId: "GET /Patient/{id}/_history/{vid}/_tags"
              produces:
              - "application/json"
              parameters:
              - name: "vid"
                in: "path"
                required: true
                type: "string"
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              operationId: "POST /Patient/{id}/_history/{vid}/_tags"
              produces:
              - "application/json"
              parameters:
              - name: "vid"
                in: "path"
                required: true
                type: "string"
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                201:
                  description: "201 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_history/{vid}/_tags/_delete:
            post:
              operationId: "POST /Patient/{id}/_history/{vid}/_tags/_delete"
              produces:
              - "application/json"
              parameters:
              - name: "vid"
                in: "path"
                required: true
                type: "string"
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                204:
                  description: "204 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_tags:
            get:
              operationId: "GET /Patient/{id}/_tags"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
            post:
              operationId: "POST /Patient/{id}/_tags"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                201:
                  description: "201 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /Patient/{id}/_tags/_delete:
            post:
              operationId: "POST /Patient/{id}/_tags/_delete"
              produces:
              - "application/json"
              parameters:
              - name: "id"
                in: "path"
                required: true
                type: "string"
              responses:
                204:
                  description: "204 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /_history:
            get:
              operationId: "GET /_history"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /_tags:
            get:
              operationId: "GET /_tags"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
          /metadata:
            get:
              operationId: "GET /metadata"
              produces:
              - "application/json"
              responses:
                200:
                  description: "200 response"
              x-amazon-apigateway-integration:
                uri: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:us-west-2:681921237057:function:PatientFHIR-Service/invocations"
                responses:
                  default:
                    statusCode: "200"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws"
                